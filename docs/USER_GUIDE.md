# Fraud Monitoring Demo – Analyst Training Guide

Audience: New fraud/cyber analysts learning the demo tool. Use this as the classroom script and hands-on lab outline. Validate each step against the running app/API before training day.

## 1) Session Plan (what trainees will do)
1) **Warm-up (read-only)**: List alerts, open an alert, view its case context.
2) **Investigate**: Check transaction details (BSP 1213 logging fields) and linked accounts/devices.
3) **AFASA handling**: Create a dispute, apply a temporary hold, log verification steps, and release/restitute.
4) **Reporting**: Pull a summary and a case bundle.
5) **(Optional)**: Trigger Telegram quick actions and see the bot output.

## 2) Getting Started
- **API base URL**: `http://localhost:5005/api` (adjust if deployed elsewhere).
- **Auth**: Demo does not enforce auth; in production add SSO/RBAC.
- **Main entities**:
  - **Alerts**: Generated by rules (FAF + AFASA heuristics).
  - **Cases**: One case per alert; holds linked accounts/devices/context.
  - **TransactionLog**: BSP 1213-aligned log of each transfer (sender, receiver, channel, auth, device/IP, etc.).
  - **AFASA Disputes**: Simulated temporary holds + verification timeline.

## 3) Core Workflows (API)

### 3.1 Refresh/Generate alerts (Instructor prep or lab reset)
- Endpoint: `POST /alerts/refresh`
- Body: optional `{"rule_id": <id>}` to limit; otherwise runs all enabled rules.
- Output: count of generated alerts.
- Purpose: Seed training data; re-run to populate alerts/cases.

### 3.2 List and inspect alerts
- List: `GET /alerts`
  - Filters: `?status=OPEN` ; `?family=FAF` to view FAF-only.
- Fields to note:
  - `severity` (CRITICAL/HIGH/MEDIUM/LOW)
  - `is_afasa`, `afasa_suspicion_type`, `afasa_risk_score`
  - `rule_name` and `summary`
- Detail: `GET /alerts/{id}` returns alert + its case (linked accounts/devices).

### 3.3 Case context
- Every alert auto-creates a case.
- Case detail is returned via `GET /alerts/{id}` (embedded) or `GET /cases/{id}` (if added).
- Use `linked_accounts` / `linked_devices` to see spread indicators (e.g., shared device across mules).

### 3.4 Transaction logs (BSP 1213 visibility)
- Table: `transaction_logs` (Postgres). Key columns:
  - `tx_reference`, `sender_account_id`, `receiver_account_id`, `amount`, `currency`, `tx_datetime`
  - `channel`, `auth_method`, `device_fingerprint`, `ip_address`, `browser_user_agent`
  - `network_reference` (ties back to graph tags or other FI references)
- For a given alert, use the `tx_ref` in `details` to look up the row; analysts can query directly or add an API in training exercises.

## 4) AFASA Dispute & Hold Flow (API)

### 4.1 Create a dispute
- Endpoint: `POST /afasa/disputes`
- Body:
  ```json
  {
    "alert_id": <alertId>,
    "tx_id": <transactionLogId>,
    "reason_category": "FMS_DETECTED" | "CUSTOMER_COMPLAINT" | "OTHER_BFI_INFO",
    "suspicion_type": "MONEY_MULE" | "SOCIAL_ENGINEERING" | "ECONOMIC_SABOTAGE" | "OTHER",
    "initiated_by": "analyst_1"
  }
  ```
- Result: Dispute in `PENDING_HOLD` with an INITIATED verification event.

### 4.2 Apply temporary hold (starts 30-day clock)
- Endpoint: `POST /afasa/disputes/{id}/hold`
- Body: `{"actor": "analyst_1"}`
- Result: Status -> `HELD`, `hold_start_at` set, `max_hold_until` = +30 days. Event logged.

### 4.3 Add verification events (customer / other BFI / BSP)
- Endpoint: `POST /afasa/disputes/{id}/events`
- Body:
  ```json
  {
    "event_type": "CUSTOMER_CONTACTED" | "CUSTOMER_RESPONSE" | "OTHER_BFI_CONTACTED" | "OTHER_BFI_RESPONSE" | "BSP_QUERY" | "ESCALATED_TO_LEA",
    "notes": "Called customer, awaiting response",
    "actor": "analyst_1"
  }
  ```
- Purpose: Build the time-stamped audit trail required by Circular 1215.

### 4.4 Release or restitute funds
- Endpoint: `POST /afasa/disputes/{id}/release`
- Body:
  ```json
  {
    "decision": "RELEASE" | "RESTITUTION" | "ESCALATE",
    "notes": "Customer confirmed phishing",
    "actor": "analyst_1"
  }
  ```
- Results:
  - `RELEASE` -> status `RELEASED`, event `FUNDS_RELEASED`.
  - `RESTITUTION` -> status `WRITTEN_OFF`, event `FUNDS_RESTITUTED`.
  - `ESCALATE` -> status `ESCALATED`, event `ESCALATED_TO_LEA`.

### 4.5 List / inspect disputes
- List: `GET /afasa/disputes?status=HELD&suspicion_type=MONEY_MULE`
- Detail: `GET /afasa/disputes/{id}` (includes verification events inline).

### 4.6 Reporting
- Summary: `GET /afasa/reports/summary` (counts by status and suspicion).
- Case bundle: `GET /afasa/reports/case/{id}` (dispute + alert metadata; extend to include transaction chain).

## 5) Telegram Bot (optional channel)
- Alerts are pushed with AFASA context and quick commands:
  - `/afasa_dispute <alert_id>`
  - `/afasa_hold <dispute_id>`
  - `/afasa_release <dispute_id> OK` or `RESTITUTE`
- Configure via env:
  - `TELEGRAM_BOT_TOKEN`, `TELEGRAM_CHAT_ID`
  - `TELEGRAM_AGENT_ENDPOINT` (top suspects API), `TELEGRAM_ASSESS_ENDPOINT` (assessment API)
- Run: `python backend/telegram_agent.py`

## 6) Investigation Aids
- **Graph view** (API `/neo4j/...`): Visualize account-device-transaction paths. Use this to explain mule fan-in/fan-out and shared devices.
- **Dispute chain**: Tie `tx_reference` to graph transfers to show upstream/downstream hops (extend with `/afasa/disputes/{id}/graph` if added).
- **Flags**: Alerts expose `is_afasa`, suspicion type, and risk score to prioritize queue.

## 7) Suggested Training Scenarios (hands-on labs)
1) **Money Mule Fan-in**  
   - List alerts, pick one with AFASA risk.  
   - Check `afasa_risk_score` and `tx_reference` details.  
   - Create dispute → apply hold → add CUSTOMER_CONTACTED event → RELEASE.
2) **Social Engineering Spike**  
   - Find alert with weak auth (OTP_SMS) in details.  
   - Create dispute → log CUSTOMER_RESPONSE as “denies” → RESTITUTION.  
   - Note how events show the timeline.
3) **Cross-BFI Coordination**  
   - Create dispute → add OTHER_BFI_CONTACTED/RESPONSE events → RELEASE.  
   - Emphasize audit trail for BSP/CAPO sharing.
4) **Max Hold Rule**  
   - Explain `max_hold_until` (30 days).  
   - (Instructor) show the `auto_enforce_max_hold_period` service that escalates expired holds.

## 8) Tips for Analysts
- Always record verification steps as events; the event log is your audit trail.
- Use `afasa_risk_score` to triage; anything ≥ threshold should be held/verified.
- Cross-check `TransactionLog` for device/IP/auth anomalies before deciding.
- Keep notes concise but specific (channel of contact, customer statement, reference numbers with other BFIs).

## 9) What’s simulated vs. real
- **Simulated**: Core banking hold/release (we only model status), cross-BFI coordination, and Telegram commands.
- **Real data paths**: Postgres holds alert/case/dispute/log records; Neo4j holds the graph for visualization.
- **Extend hooks**: Add RBAC/auth, integrate real core holds, and enrich graph queries for dispute chains.

## 10) Quick Reference (Endpoints)
- `POST /alerts/refresh`
- `GET /alerts`, `GET /alerts/{id}`
- `POST /afasa/disputes`
- `POST /afasa/disputes/{id}/hold`
- `POST /afasa/disputes/{id}/release`
- `POST /afasa/disputes/{id}/events`
- `GET /afasa/disputes`, `GET /afasa/disputes/{id}`
- `GET /afasa/reports/summary`, `GET /afasa/reports/case/{id}`
